<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/framer-motion@2.0.0-beta.31/dist/framer-motion.dev.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.js"></script>
  <script src="/babel-plugin-magic.js"></script>
  <script src="/domElements.js"></script>
  <script src="/config.js"></script>
  <script src="/colors.js"></script>
  <script src="/theme.js"></script>
  <script type="text/babel" src="/theme-provider.js"></script>
  <script
    type="text/babel"
    data-presets="env,typescript"
    src="/magic/parser.ts"
  ></script>
  <script type="text/babel" data-plugins="magic">
    const { motion } = Motion;

    const __DEV__ = true;

    const get = (obj, key, def, p, undef) => {
      key = key && key.split ? key.split(".") : [key];
      for (p = 0; p < key.length; p++) {
        obj = obj ? obj[key[p]] : undef;
      }
      return obj === undef ? def : obj;
    };

    const createParser = (config) => {
      return (props, theme) => {
        
      }
    }

    const interpolate = (styles = {}, theme) => {
      let computedStyle = {};
      let otherProps = {};
      for (var key in styles) {
        const parser = config[key];
        const value = styles[key];
        console.log(key, parser, value);
        // if not a style prop (no value in config)
        if (!parser) {
          otherProps[key] = value;
          continue;
        } 
        
        // if config is `true` 
        if (parser === true) {
          computedStyle[key] = value;
          continue;
        } 

        const scaleName = theme[parser]
        
        if (theme[parser]) {
          computedStyle[key] = get(theme[parser], value, value);
        }
      }

      return { computedStyle, otherProps };
    };

    const createMagic = (component) => {
      const Magic = React.forwardRef(
        ({ children, style = {}, ...props }, ref) => {
          // Grab a shallow copy of the props
          // _ctx.p: is the props sent to the context

          // Set a flag if the current components had a previous className
          // similar to goober. This is the append/prepend flag
          let append = /\s*go[0-9]+/g.test(props.className);

          // const { result, other } = css(props)(useTheme());
          // console.log(result, other);
          // Define the new className
          const theme = useTheme();
          const { computedStyleProps, otherProps } = interpolate(props, theme);
          const { computedStyle } = interpolate(style, theme);
          const computedClassName = hash(
            computedStyleProps,
            getSheet(document && document.head),
            false,
            append
          );
          const className = `${computedClassName}${
            props.className ? ` ${props.className}` : ""
          }`;

          return React.createElement(
            props.as || motion[component],
            Object.assign({}, otherProps, {
              ref,
              children,
              style: computedStyle,
              className
            })
          );
        }
      );

      if (__DEV__) {
        Magic.displayName = `Magic(${
          typeof component === "string"
            ? component
            : component.displayName || component.name || "Component"
        })`;
      }

      return Magic;
    };

    const magic = createMagic;
    domElements.forEach((el) => {
      magic[el] = createMagic(el);
    });

    function CharacterCount({ text }) {
      const theme = useTheme();
      return (
        <div
          style={{ color: "red" }}
          backgroundColor="blue.100"
          animate={{ x: 10 }}
        >
          {`The text "${text}" has `}
          {text.length ? <strong>{text.length}</strong> : "No"}
          {" characters"}
        </div>
      );
    }

    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CharacterCount text="Hello World" />
      </ThemeProvider>,
      document.getElementById("root")
    );
  </script>
</body>
